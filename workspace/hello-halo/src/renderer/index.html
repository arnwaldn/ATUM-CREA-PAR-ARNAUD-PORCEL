<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; font-src 'self' data:; img-src 'self' data: blob: atum-file: https:; connect-src 'self' ws: wss: http://localhost:* http://127.0.0.1:* http://192.168.*:* http://10.*:* http://172.16.*:* https://*.trycloudflare.com wss://*.trycloudflare.com https://api.anthropic.com https://api.claude.ai https://*.anthropic.com https://*.claude.ai https://registry.npmjs.org; frame-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'"
    />
  <title>ATUM CREA</title>
    <style>
      /* Anti-flash: set background before CSS loads */
      html, body, #root { background-color: #0a0a0a; }
      html.light, html.light body, html.light #root { background-color: #ffffff; }
    </style>
    <script>
      // Anti-flash: apply theme before render (default: dark)
      (function() {
        try {
          var theme = localStorage.getItem('atum-theme');
          if (theme === 'light') {
            document.documentElement.classList.add('light');
          } else if (theme === 'system') {
            // system: check preference
            if (!window.matchMedia('(prefers-color-scheme: dark)').matches) {
              document.documentElement.classList.add('light');
            }
          }
          // default (no localStorage or 'dark'): stay dark, do nothing
        } catch (e) {}
      })();
    </script>
  </head>
  <body>
    <div id="root"></div>

    <!-- Global Error Fallback: catches fatal errors before React mounts -->
    <div id="global-error-fallback" style="
      display: none;
      position: fixed;
      inset: 0;
      background: #0a0a0a;
      color: #e5e5e5;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 40px;
      overflow: auto;
    ">
      <div style="max-width: 600px; margin: 0 auto;">
        <div style="
          width: 48px;
          height: 48px;
          border-radius: 50%;
          border: 2px solid #6366f1;
          opacity: 0.6;
          margin-bottom: 24px;
        "></div>
        <h1 style="font-size: 20px; font-weight: 500; margin: 0 0 8px 0;">
          ATUM CREA failed to start
        </h1>
        <p style="color: #a1a1aa; margin: 0 0 24px 0; font-size: 14px;">
          An error occurred before the application could load. Please copy the error below and report it.
        </p>
        <pre id="global-error-message" style="
          background: #18181b;
          border: 1px solid #27272a;
          border-radius: 8px;
          padding: 16px;
          font-family: 'SF Mono', Monaco, Consolas, monospace;
          font-size: 12px;
          line-height: 1.5;
          overflow-x: auto;
          white-space: pre-wrap;
          word-break: break-all;
          color: #f87171;
          margin: 0;
          user-select: text;
        "></pre>
        <p style="color: #71717a; margin: 16px 0 0 0; font-size: 12px;">
          Try restarting the application. If the problem persists, please report at
          <span style="color: #6366f1;">github.com/atumcrea/atum-crea/issues</span>
        </p>
      </div>
    </div>

    <script>
      // Global error handler for fatal errors before React mounts
      (function() {
        window.__ATUM_APP_MOUNTED__ = false;

        function showFatalError(message) {
          if (window.__ATUM_APP_MOUNTED__) return; // React is handling errors

          var fallback = document.getElementById('global-error-fallback');
          var errorMsg = document.getElementById('global-error-message');
          var root = document.getElementById('root');

          if (fallback && errorMsg) {
            root.style.display = 'none';
            fallback.style.display = 'block';
            errorMsg.textContent = message;
          }
        }

        window.onerror = function(msg, url, line, col, error) {
          var detail = msg;
          if (url) detail += '\n\nFile: ' + url.split('/').pop() + ':' + line + ':' + col;
          if (error && error.stack) detail += '\n\nStack:\n' + error.stack;
          showFatalError(detail);
          return !window.__ATUM_APP_MOUNTED__; // Suppress only if React not mounted
        };

        window.onunhandledrejection = function(event) {
          var reason = event.reason;
          var message = reason instanceof Error
            ? reason.message + (reason.stack ? '\n\nStack:\n' + reason.stack : '')
            : String(reason);

          // Ignore Vite HMR WebSocket errors - they are non-fatal and expected
          // when the app is accessed via remote proxy (port differs from Vite dev server)
          if (message && (
            message.indexOf('@vite/client') !== -1 ||
            message.indexOf('__vite') !== -1 ||
            message.indexOf("Failed to construct 'WebSocket'") !== -1
          )) {
            console.warn('[Global] Ignoring non-fatal Vite HMR error:', message);
            return;
          }

          showFatalError('Unhandled Promise Rejection:\n\n' + message);
        };
      })();
    </script>

    <script type="module" src="./main.tsx"></script>
  </body>
</html>
